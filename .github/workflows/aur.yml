name: Publish MeerK40t to AUR

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  publish-to-aur:
    name: >-
      Publish meerk40t to AUR
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up SSH for AUR
      env:
        AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        AUR_SSH_KNOWN_HOSTS: ${{ secrets.AUR_SSH_KNOWN_HOSTS }}
      run: |
        mkdir -p ~/.ssh
        echo "$AUR_SSH_KEY" > ~/.ssh/aur
        chmod 600 ~/.ssh/aur
        echo "Host aur.archlinux.org" >> ~/.ssh/config
        echo "  User aur" >> ~/.ssh/config
        echo "  HostName aur.archlinux.org" >> ~/.ssh/config
        echo "  IdentityFile ~/.ssh/aur" >> ~/.ssh/config
        echo "  AddKeysToAgent yes" >> ~/.ssh/config
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/aur
        mkdir -p ~/.ssh
        echo "$AUR_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts

    - name: Extract version from setup.cfg
      id: version
      run: |
        VERSION=$(grep "version = " setup.cfg | head -1 | cut -d' ' -f3)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION"

    - name: Clone AUR repository
      run: |
        git clone ssh://aur@aur.archlinux.org/meerk40t.git aur-repo

    - name: Configure git for AUR
      run: |
        git config --global user.name "GitHub Actions CI"
        git config --global user.email "actions@github.com"

    - name: Update PKGBUILD
      run: |
        cd aur-repo
        VERSION="${{ steps.version.outputs.version }}"
        
        # Update pkgver in PKGBUILD
        sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
        
        # Reset pkgrel to 1 for new upstream version
        sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
        
        # Calculate SHA256 checksum of the release tarball
        TARBALL_URL="https://github.com/meerk40t/meerk40t/archive/refs/tags/v${VERSION}.tar.gz"
        SHA256=$(curl -sL "$TARBALL_URL" | sha256sum | cut -d' ' -f1)
        
        # Update sha256sums in PKGBUILD
        sed -i "s/^sha256sums=.*/sha256sums=('$SHA256')/" PKGBUILD

    - name: Generate .SRCINFO
      run: |
        cd aur-repo
        
        # Install required tools
        sudo apt-get update -qq
        sudo apt-get install -qq -y bash
        
        # Generate .SRCINFO using a Python script since makepkg isn't available
        python3 << 'EOF'
        import re
        
        with open('PKGBUILD', 'r') as f:
            pkgbuild = f.read()
        
        # Extract variables from PKGBUILD
        vars = {}
        for match in re.finditer(r'^(\w+)=(.+)$', pkgbuild, re.MULTILINE):
            key, val = match.groups()
            # Remove quotes and evaluate simple values
            val = val.strip().strip('\'"')
            vars[key] = val
        
        # Generate .SRCINFO content
        srcinfo = f"""# Generated by CI/CD
pkgbase = {vars.get('pkgname', 'meerk40t')}
	pkgdesc = {vars.get('pkgdesc', '')}
	pkgver = {vars.get('pkgver', '0.9.8220')}
	pkgrel = {vars.get('pkgrel', '1')}
	url = {vars.get('url', '')}
	arch = {vars.get('arch', 'x86_64')}
	license = {vars.get('license', 'MIT')}
	makedepends = {vars.get('makedepends', 'python-build')}
	depends = {vars.get('depends', 'python')}
	optdepends = {vars.get('optdepends', '')}
	source = {vars.get('source', '')}
	sha256sums = {vars.get('sha256sums', '')}

pkgname = {vars.get('pkgname', 'meerk40t')}
"""
        
        with open('.SRCINFO', 'w') as f:
            f.write(srcinfo)
        
        print(".SRCINFO generated successfully")
        EOF

    - name: Commit and push to AUR
      run: |
        cd aur-repo
        
        VERSION="${{ steps.version.outputs.version }}"
        
        # Check if there are changes
        if git diff --quiet PKGBUILD .SRCINFO; then
          echo "No changes to commit"
          exit 0
        fi
        
        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master

    - name: Cleanup SSH
      if: always()
      run: |
        rm -f ~/.ssh/aur
        rm -f ~/.ssh/config
        rm -f ~/.ssh/known_hosts

    - name: Publish release note
      if: github.event_name == 'release'
      uses: actions/github-script@v7
      with:
        script: |
          const release = context.payload.release;
          console.log(`âœ“ Published to AUR: ${release.tag_name}`);
