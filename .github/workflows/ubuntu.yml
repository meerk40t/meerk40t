# This workflow builds PyInstaller single-file executables
# of Meerk40t for Ubuntu (latest)

name: Meerk40t (Ubuntu)

on:
  workflow_dispatch:

  release:
    types: [published]

jobs:
  build-ubuntu:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout sefrocut
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          cmake \
          libeigen3-dev \
          libagg-dev \
          libpotrace-dev \
          python3-dev \
          wget \
          fuse \
          libfuse2 \
          desktop-file-utils \
          imagemagick

    - name: Install Python dependencies
      run: |
        python3 -m ensurepip --upgrade
        python3 -m pip install --upgrade pip
        pip cache purge
        pip install setuptools==65.5.1
        pip install pyinstaller wheel
        
        # Install wxPython for Ubuntu 22.04
        pip install --only-binary=all -U -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04 wxPython
        
        # Install core dependencies from requirements.txt
        pip install -r requirements.txt
        
        # Install pyclipr with PEP 517 to avoid deprecation warning
        pip install --use-pep517 pyclipr
        
        # Install Linux-specific optional dependencies
        pip install -r requirements-optional-linux.txt
        
        # Install additional packages not in requirements files
        pip install bitarray
        
        # Install project in development mode
        pip install -e .
        pip install sefrocut-barcodes

    - name: Generate icons
      run: |
        # Generate icons using the build script
        chmod +x tools/build_icon.sh
        tools/build_icon.sh "w${{ github.run_number }}"

    - name: pip list
      run: |
          pip list

    - name: Build sefrocut
      run: |
        cd sefrocut
        mv external_plugins.py external_plugins.unused
        mv external_plugins_build.py external_plugins.py
        cd ..

        # Use the build spec which is known to work
        pyinstaller .github/workflows/linux/sefrocut_build.spec

        # Restore original files
        cd sefrocut
        mv external_plugins.py external_plugins_build.py
        mv external_plugins.unused external_plugins.py
        cd ..

        # Rename for expected output
        mv dist/SefroCut dist/SefroCut-Ubuntu-Latest

    - name: Create AppImage
      run: |
        # Download appimagetool
        wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool

        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        mkdir -p AppDir/usr/share/metainfo

        # Copy the PyInstaller executable
        cp dist/SefroCut-Ubuntu-Latest AppDir/usr/bin/sefrocut
        chmod +x AppDir/usr/bin/sefrocut

        # Copy icon - should already be in PNG format from build_icon.sh
        if [ -f "sefrocut.png" ]; then
          # Copy to proper freedesktop.org location
          cp sefrocut.png AppDir/usr/share/icons/hicolor/256x256/apps/sefrocut.png
          # Also copy to AppDir root for desktop file to find it
          cp sefrocut.png AppDir/sefrocut.png
        else
          # Fallback to ICO if needed
          cp sefrocut.ico AppDir/usr/share/icons/hicolor/256x256/apps/sefrocut.ico
        fi

        # Copy desktop file and other metadata from repo
        cp .github/workflows/linux/sefrocut.desktop AppDir/usr/share/applications/sefrocut.desktop
        cp .github/workflows/linux/sefrocut.desktop AppDir/
        
        # Copy AppStream metainfo
        cp .github/workflows/linux/sefrocut.appdata.xml AppDir/usr/share/metainfo/

        # Copy AppRun script
        cp .github/workflows/linux/AppRun AppDir/
        chmod +x AppDir/AppRun

        # Create AppImage
        ./appimagetool AppDir SefroCut-Ubuntu-Latest.AppImage

        # Move to dist directory
        mv SefroCut-Ubuntu-Latest.AppImage dist/

    - name: Upload Release Assets
      id: release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          dist/SefroCut-Ubuntu-Latest
          dist/SefroCut-Ubuntu-Latest.AppImage
