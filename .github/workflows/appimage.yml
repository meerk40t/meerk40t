name: Create Linux AppImage

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libpotrace-dev \
          python3-dev \
          fuse \
          libfuse2 \
          desktop-file-utils \
          imagemagick \
          libeigen3-dev \
          libagg-dev \
          cmake \
          libnotify-dev \
          libsdl2-dev

        pip install --upgrade pip setuptools wheel pyinstaller
        pip install --only-binary=all -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04 wxPython
        pip install -r requirements.txt
        pip install --use-pep517 pyclipr
        pip install -r requirements-optional-linux.txt
        pip install bitarray
        pip install -e .

    - name: Generate Assets
      run: |
        chmod +x tools/build_icon.sh
        tools/build_icon.sh "w${{ github.run_number }}"

    - name: Build Application
      run: |
        cd meerk40t
        mv external_plugins.py external_plugins.unused
        mv external_plugins_build.py external_plugins.py
        cd ..
        
        # Build with PyInstaller (Onedir)
        mv meerk40t.py mk40t.py
        pyinstaller .github/workflows/linux/meerk40t_build.spec
        mv mk40t.py meerk40t.py

    - name: Create AppImage
      run: |
        # Setup tools
        wget -q -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        wget -q -O linuxdeploy "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
        wget -q -O linuxdeploy-plugin-gtk "https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh"
        chmod +x appimagetool linuxdeploy linuxdeploy-plugin-gtk

        # Prepare AppDir
        mkdir -p AppDir/usr/bin
        # Copy onedir contents to AppDir/usr/bin
        cp -r dist/MeerK40t/* AppDir/usr/bin/
        
        # Ensure executable name matches AppRun expectation (lowercase meerk40t)
        if [ -f AppDir/usr/bin/MeerK40t ]; then
            mv AppDir/usr/bin/MeerK40t AppDir/usr/bin/meerk40t
        fi

        # Default fallback if copy failed to bring in binary (paranoid check)
        if [ ! -f AppDir/usr/bin/meerk40t ]; then
             echo "Error: Main executable meerk40t not found in AppDir/usr/bin"
             ls -R AppDir
             exit 1
        fi

        # Use our custom AppRun which sets LD_LIBRARY_PATH for wx
        cp .github/workflows/linux/AppRun AppDir/AppRun
        chmod +x AppDir/AppRun
        
        # Setup Desktop Integration
        mkdir -p AppDir/usr/share/applications AppDir/usr/share/metainfo AppDir/usr/share/icons/hicolor/256x256/apps
        cp .github/workflows/linux/io.github.meerk40t.meerk40t.desktop AppDir/usr/share/applications/
        cp .github/workflows/linux/meerk40t.appdata.xml AppDir/usr/share/metainfo/
        
        # Icon handling
        if [ -f "meerk40t.png" ]; then
            cp meerk40t.png AppDir/usr/share/icons/hicolor/256x256/apps/meerk40t.png
            cp meerk40t.png AppDir/meerk40t.png
        elif [ -f "meerk40t.ico" ]; then
            convert meerk40t.ico AppDir/usr/share/icons/hicolor/256x256/apps/meerk40t.png
            cp AppDir/usr/share/icons/hicolor/256x256/apps/meerk40t.png AppDir/meerk40t.png
        fi

        # Bundle with linuxdeploy and build AppImage
        export LINUXDEPLOY_PLUGIN_GTK="$PWD/linuxdeploy-plugin-gtk"
        ./linuxdeploy \
            --appdir AppDir \
            --plugin gtk \
            --executable AppDir/usr/bin/meerk40t \
            --desktop-file AppDir/usr/share/applications/io.github.meerk40t.meerk40t.desktop \
            --icon-file AppDir/meerk40t.png \
            --output appimage

        # Rename output
        mv MeerK40t*.AppImage MeerK40t-linux-x86_64.AppImage

    - name: Test AppImage
      run: |
        echo "This is attempt #1.000.006"
        chmod +x MeerK40t-linux-x86_64.AppImage
        # Run with -z (no-gui) but ensuring it attempts to load wx (via kernel lifecycle)
        # and then quits. This validates the executable structure without needing a display.
        ./MeerK40t-linux-x86_64.AppImage -z -e "quit"

    - name: Store Artifact
      uses: actions/upload-artifact@v4
      with:
        name: meerk40t-linux-appimage
        path: MeerK40t-linux-x86_64.AppImage
