name: Create Linux AppImage

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-appimage:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          cmake \
          libeigen3-dev \
          libagg-dev \
          libpotrace-dev \
          python3-dev \
          wget \
          fuse \
          libfuse2 \
          desktop-file-utils \
          imagemagick

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools==65.5.1 wheel pyinstaller

        pip install --only-binary=all -U -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04 wxPython

        # Install core dependencies from requirements.txt
        pip install -r requirements.txt

        # Install pyclipr with PEP 517 to avoid deprecation warning
        pip install --use-pep517 pyclipr

        # Install Linux-specific optional dependencies
        pip install -r requirements-optional-linux.txt

        # Install additional packages not in requirements files
        pip install bitarray

        # Install project in development mode
        pip install -e .

    - name: Generate icons
      run: |
        # Generate icons using the build script
        chmod +x tools/build_icon.sh
        tools/build_icon.sh "w${{ github.run_number }}"

    - name: Build with PyInstaller
      run: |
        cd meerk40t
        mv external_plugins.py external_plugins.unused
        mv external_plugins_build.py external_plugins.py
        cd ..

        mv meerk40t.py mk40t.py
        pyinstaller .github/workflows/linux/meerk40t_build.spec
        mv mk40t.py meerk40t.py

    - name: Verify onedir output
      run: |
        if [ ! -d "dist/MeerK40t" ]; then
          echo "FAIL: dist/MeerK40t is not a directory â€” PyInstaller produced onefile output"
          file dist/MeerK40t 2>/dev/null
          exit 1
        fi
        echo "OK: dist/MeerK40t is a directory (onedir)"
        ls -la dist/MeerK40t/

    - name: Create AppImage
      run: |
        # Download appimagetool
        wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool

        # Download linuxdeploy and GTK plugin to bundle runtime libraries
        wget -O linuxdeploy "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
        wget -O linuxdeploy-plugin-gtk "https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh"
        chmod +x linuxdeploy linuxdeploy-plugin-gtk

        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        mkdir -p AppDir/usr/share/metainfo

        # Copy the onedir output (preserves wx/.libs/ layout needed for RPATHs)
        cp -r dist/MeerK40t/* AppDir/usr/bin/
        mv AppDir/usr/bin/MeerK40t AppDir/usr/bin/meerk40t
        chmod +x AppDir/usr/bin/meerk40t

        # Copy icon - should already be in PNG format from build_icon.sh
        echo "Checking for icon files..."
        ls -la meerk40t.ico meerk40t.png 2>/dev/null || echo "Icon files not found"

        if [ -f "meerk40t.png" ]; then
          echo "Found meerk40t.png, copying to AppDir locations..."
          # Copy to proper freedesktop.org location
          cp meerk40t.png AppDir/usr/share/icons/hicolor/256x256/apps/meerk40t.png
          # Also copy to AppDir root for desktop file to find it
          cp meerk40t.png AppDir/meerk40t.png
          echo "Icon copy completed successfully"
        else
          echo "WARNING: meerk40t.png not found. Checking if we can convert from ICO..."
          if [ -f "meerk40t.ico" ]; then
            echo "Attempting fallback conversion from ICO to PNG..."
            if convert meerk40t.ico AppDir/usr/share/icons/hicolor/256x256/apps/meerk40t.png 2>&1; then
              cp AppDir/usr/share/icons/hicolor/256x256/apps/meerk40t.png AppDir/meerk40t.png
              echo "Fallback conversion succeeded"
            else
              echo "WARNING: Fallback conversion failed. AppImage will not have a custom icon."
            fi
          else
            echo "WARNING: Neither meerk40t.png nor meerk40t.ico found. AppImage will not have a custom icon."
          fi
        fi

        # Copy desktop file (reverse-DNS filename avoids AppStream warnings)
        cp .github/workflows/linux/io.github.meerk40t.meerk40t.desktop \
          AppDir/usr/share/applications/io.github.meerk40t.meerk40t.desktop
        cp .github/workflows/linux/io.github.meerk40t.meerk40t.desktop AppDir/
        chmod +x AppDir/io.github.meerk40t.meerk40t.desktop

        # Copy AppStream metainfo 
        cp .github/workflows/linux/meerk40t.appdata.xml \
          AppDir/usr/share/metainfo/io.github.meerk40t.meerk40t.appdata.xml

        # Bundle runtime libraries (GTK, etc.) into AppDir
        export PATH="$PWD:$PATH"
        export LINUXDEPLOY_PLUGIN_GTK="$PWD/linuxdeploy-plugin-gtk"
        export DEPLOY_GTK_VERSION=3
        ./linuxdeploy \
          --appdir AppDir \
          --executable AppDir/usr/bin/meerk40t \
          --desktop-file AppDir/io.github.meerk40t.meerk40t.desktop \
          --icon-file AppDir/meerk40t.png \
          --plugin gtk

        # Copy AppRun script (override linuxdeploy default)
        cp .github/workflows/linux/AppRun AppDir/
        chmod +x AppDir/AppRun

        # Restore wx package from pristine PyInstaller output.
        # linuxdeploy patches RPATHs on every ELF it finds; for wx this
        # replaces $ORIGIN/.libs (where wx vendors libwx*) with
        # $ORIGIN/../lib.  Overwriting with the original files restores
        # the correct RPATHs.  AppRun also exposes wx/.libs via
        # LD_LIBRARY_PATH as a belt-and-suspenders safety net.
        if [ -d "dist/MeerK40t/wx" ]; then
          cp -r dist/MeerK40t/wx AppDir/usr/bin/
        fi

        # Build AppImage
        if [ -n "${{ github.event.release.tag_name }}" ]; then
          APPIMAGE_TAG="${{ github.event.release.tag_name }}"
        else
          APPIMAGE_TAG="${{ github.sha }}"
        fi
        ./appimagetool AppDir meerk40t-${APPIMAGE_TAG}-x86_64.AppImage

    - name: Test AppImage
      run: |
        if [ -n "${{ github.event.release.tag_name }}" ]; then
          APPIMAGE_TAG="${{ github.event.release.tag_name }}"
        else
          APPIMAGE_TAG="${{ github.sha }}"
        fi
        chmod +x meerk40t-${APPIMAGE_TAG}-x86_64.AppImage
        # --version exits before any plugin loads, so it cannot catch wx import
        # failures.  Use xvfb-run with --no-gui instead: this boots the full
        # kernel (including the gui plugin's wx import gate) and exits cleanly.
        sudo apt-get install -y xvfb > /dev/null 2>&1
        timeout 15s xvfb-run ./meerk40t-${APPIMAGE_TAG}-x86_64.AppImage --no-gui -e "quit"
        if [ $? -ne 0 ]; then
          echo "ERROR: AppImage smoke test failed."
          exit 1
        fi

    - name: Check AppImage exists before upload
      if: github.event_name == 'release'
      run: |
        APPIMAGE_TAG="${{ github.event.release.tag_name }}"
        if [ ! -f "meerk40t-${APPIMAGE_TAG}-x86_64.AppImage" ]; then
          echo "ERROR: AppImage file meerk40t-${APPIMAGE_TAG}-x86_64.AppImage not found. Upload step will fail."
          exit 1
        fi

    - name: Upload AppImage to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          meerk40t-${{ github.event.release.tag_name }}-x86_64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload AppImage as Artifact
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: meerk40t-appimage
        path: meerk40t-${{ github.sha }}-x86_64.AppImage
